#!/bin/bash
#
# TDD Workflow Script for New Features
#
# Usage: bin/tdd-new-feature "FeatureName" [test-file-path]
#
# This script enforces TRUE TDD by:
# 1. Creating a failing spec test FIRST
# 2. Running the test to confirm RED phase
# 3. Guiding developer through red-green-refactor cycle
#
# Examples:
#   bin/tdd-new-feature "StatusCommand"
#   bin/tdd-new-feature "MessageFilter" "tests/Specification/MessageFilterSpecTest.php"
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Print formatted messages
print_header() {
    echo -e "\n${BLUE}═══════════════════════════════════════════════════════════════${NC}"
    echo -e "${BLUE}  $1${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}\n"
}

print_step() {
    echo -e "${YELLOW}▶ $1${NC}"
}

print_success() {
    echo -e "${GREEN}✓ $1${NC}"
}

print_error() {
    echo -e "${RED}✗ $1${NC}"
}

print_info() {
    echo -e "${BLUE}ℹ $1${NC}"
}

# Validate arguments
if [ -z "$1" ]; then
    echo "Usage: $0 <FeatureName> [test-file-path]"
    echo ""
    echo "Arguments:"
    echo "  FeatureName    - Name of the feature (PascalCase, e.g., 'StatusCommand')"
    echo "  test-file-path - Optional: Custom path for test file"
    echo ""
    echo "Examples:"
    echo "  $0 StatusCommand"
    echo "  $0 MessageFilter tests/Specification/CustomPathSpecTest.php"
    exit 1
fi

FEATURE_NAME="$1"
TEST_FILE="${2:-tests/Specification/${FEATURE_NAME}SpecTest.php}"

# Ensure tests/Specification directory exists
mkdir -p "$(dirname "$TEST_FILE")"

print_header "TDD Workflow: $FEATURE_NAME"

# Check if test file already exists
if [ -f "$TEST_FILE" ]; then
    print_error "Test file already exists: $TEST_FILE"
    echo ""
    read -p "Do you want to run the existing test? (y/N) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        print_step "Running existing test..."
        ./vendor/bin/phpunit "$TEST_FILE" --colors=always || true
    fi
    exit 1
fi

print_step "Creating spec test skeleton: $TEST_FILE"

# Generate namespace from test file path
NAMESPACE="NashGao\\InteractiveShell\\Tests\\Specification"
if [[ "$TEST_FILE" == *"/"* ]]; then
    # Extract subdirectory if any beyond tests/Specification/
    SUBDIR=$(dirname "$TEST_FILE" | sed 's|tests/Specification||' | sed 's|^/||' | sed 's|/|\\|g')
    if [ -n "$SUBDIR" ]; then
        NAMESPACE="${NAMESPACE}\\${SUBDIR}"
    fi
fi

# Generate class name from filename
CLASS_NAME=$(basename "$TEST_FILE" .php)

# Create the spec test file with deliberate failure
cat > "$TEST_FILE" << EOF
<?php

declare(strict_types=1);

namespace ${NAMESPACE};

use PHPUnit\Framework\TestCase;

/**
 * SPECIFICATION: ${FEATURE_NAME}
 *
 * Consumer Perspective: What does a user of this library expect?
 * [TODO: Describe what a consumer expects from this feature]
 *
 * ═══════════════════════════════════════════════════════════════════════════
 * RED PHASE CHECKLIST (MANDATORY - verify before writing implementation):
 * ═══════════════════════════════════════════════════════════════════════════
 * - [ ] This test was written BEFORE any implementation code
 * - [ ] Test ran and FAILED (proving it tests something real)
 * - [ ] Failure message clearly describes what's missing
 * - [ ] Test is from consumer's perspective (not internal APIs)
 * - [ ] Test name describes a requirement, not implementation
 *
 * ═══════════════════════════════════════════════════════════════════════════
 * TDD WORKFLOW REMINDER:
 * ═══════════════════════════════════════════════════════════════════════════
 * 1. RED:    Write this test → Run → See it FAIL
 * 2. GREEN:  Write MINIMAL code to pass → Run → See it PASS
 * 3. REFACTOR: Clean up while keeping tests passing
 *
 * DO NOT read implementation code before writing tests!
 * DO NOT write more implementation than needed to pass!
 */
final class ${CLASS_NAME} extends TestCase
{
    /**
     * SPECIFICATION: [Describe consumer expectation here]
     *
     * This test deliberately fails to enforce red-green-refactor workflow.
     * Replace this with your actual specification test.
     */
    public function testRedPhaseDeliberateFailure(): void
    {
        // Given: [Set up the scenario from consumer's perspective]
        // TODO: Replace this with actual test setup

        // When: [Perform the action the consumer would take]
        // TODO: Replace this with actual consumer action

        // Then: [Assert the expected outcome]
        \$this->fail(
            'RED PHASE: This test must fail initially. ' .
            'Replace this with a real specification test for ${FEATURE_NAME}. ' .
            'Remember: Write what the consumer EXPECTS, not what the code DOES.'
        );
    }

    /**
     * TEMPLATE: Consumer can [action] and [expected outcome]
     *
     * Use this template for your specification tests.
     * Uncomment and modify as needed.
     */
    // public function testConsumerCan[Action][ExpectedOutcome](): void
    // {
    //     // Given: Consumer has [preconditions]
    //
    //     // When: Consumer [performs action]
    //
    //     // Then: Consumer [sees expected outcome]
    //     \$this->assertTrue(false, 'TODO: Implement this spec test');
    // }
}
EOF

print_success "Created spec test file: $TEST_FILE"

echo ""
print_step "Running test to confirm RED phase (test MUST fail)..."
echo ""

# Run the test - it should fail
if ./vendor/bin/phpunit "$TEST_FILE" --colors=always 2>/dev/null; then
    echo ""
    print_error "UNEXPECTED: Test passed! This should NOT happen."
    print_error "The skeleton test should fail to enforce red-green-refactor."
    echo ""
    exit 1
else
    echo ""
    print_success "Test FAILED as expected - RED phase confirmed!"
fi

echo ""
print_header "Next Steps"

echo "1. ${YELLOW}Edit the test file${NC}: $TEST_FILE"
echo "   - Replace the deliberate failure with your real specification"
echo "   - Write what the CONSUMER expects, not what code does"
echo "   - Do NOT read implementation code yet!"
echo ""
echo "2. ${YELLOW}Run the test${NC} to confirm it still fails:"
echo "   ./vendor/bin/phpunit $TEST_FILE"
echo ""
echo "3. ${YELLOW}Write MINIMAL implementation${NC} to make test pass:"
echo "   - Only enough code to pass the test"
echo "   - No extra features or 'nice to have'"
echo ""
echo "4. ${YELLOW}Run the test${NC} to confirm GREEN phase:"
echo "   ./vendor/bin/phpunit $TEST_FILE"
echo ""
echo "5. ${YELLOW}Refactor${NC} while keeping tests passing"
echo ""

print_header "TDD Verification Checklist"

echo "Before declaring 'done', verify:"
echo "  [ ] Spec test written BEFORE implementation"
echo "  [ ] Test ran and FAILED (red phase)"
echo "  [ ] Minimal code written to pass"
echo "  [ ] Test passes (green phase)"
echo "  [ ] Code refactored while tests pass"
echo "  [ ] PHPStan clean: ./vendor/bin/phpstan analyze"
echo "  [ ] All tests pass: ./vendor/bin/phpunit"
echo ""
